#!/data/data/com.termux/files/usr/bin/bash

VERSION="8.0.0"

GREEN="\033[1;32m"
RED="\033[1;31m"
CYAN="\033[1;36m"
YELLOW="\033[1;33m"
RESET="\033[0m"

PREFIX=/data/data/com.termux/files/usr
HTDOCS=/storage/emulated/0/htdocs
BACKUP_DIR=$HTDOCS/backup

status(){
clear
echo "=========== AAMP MAI v$VERSION ==========="
pgrep httpd >/dev/null && echo -e "Apache : ${GREEN}RUNNING${RESET}" || echo -e "Apache : ${RED}STOPPED${RESET}"
pgrep mysqld >/dev/null && echo -e "MySQL  : ${GREEN}RUNNING${RESET}" || echo -e "MySQL  : ${RED}STOPPED${RESET}"
echo "==========================================="
echo ""
}

backup_db(){
mkdir -p "$BACKUP_DIR"
mysqldump --all-databases > "$BACKUP_DIR/backup_$(date +%F_%H%M%S).sql"
echo -e "${GREEN}Backup completed.${RESET}"
}

restore_db(){
read -p "Enter backup filename: " file
mysql < "$BACKUP_DIR/$file"
echo -e "${GREEN}Restore completed.${RESET}"
}

secure_mode(){
echo -e "${YELLOW}Enabling secure mode...${RESET}"
sed -i "s/AllowNoPassword.*/AllowNoPassword = false/" $HTDOCS/phpmyadmin/config.inc.php
echo -e "${GREEN}Secure mode enabled.${RESET}"
}

update_mai(){
echo -e "${CYAN}Updating AAMP MAI...${RESET}"
curl -s -L https://raw.githubusercontent.com/aripin-ilham/mai-aamp/main/mai -o $PREFIX/bin/mai
chmod +x $PREFIX/bin/mai
echo -e "${GREEN}Updated successfully.${RESET}"
}

repair(){
echo -e "${CYAN}Running repair...${RESET}"
pkg reinstall php-apache mariadb -y >/dev/null 2>&1
echo -e "${GREEN}Repair completed.${RESET}"
}

uninstall(){
echo -e "${RED}Removing AAMP MAI...${RESET}"
pkill mysqld
apachectl stop
pkg uninstall php-apache mariadb -y >/dev/null 2>&1
rm -rf "$HTDOCS"
rm -f "$PREFIX/bin/mai"
echo -e "${GREEN}Uninstalled.${RESET}"
exit
}

if [ "$1" = "uninstall" ]; then uninstall; fi
if [ "$1" = "update" ]; then update_mai; exit; fi
if [ "$1" = "repair" ]; then repair; exit; fi

while true; do
status
echo "1) Start Apache"
echo "2) Start MySQL"
echo "3) Start All"
echo "4) Stop All"
echo "5) Backup Database"
echo "6) Restore Database"
echo "7) Secure Mode"
echo "8) Update MAI"
echo "9) Repair"
echo "10) Uninstall"
echo "11) Exit"
echo ""
read -p "Choose: " opt

case $opt in
1) apachectl start ;;
2) mysqld >/dev/null 2>&1 & ;;
3) mysqld >/dev/null 2>&1 & sleep 2; apachectl start ;;
4) pkill mysqld; apachectl stop ;;
5) backup_db ;;
6) restore_db ;;
7) secure_mode ;;
8) update_mai ;;
9) repair ;;
10) uninstall ;;
11) exit ;;
esac
done
